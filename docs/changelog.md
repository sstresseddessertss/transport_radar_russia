# Changelog

## [2026-02-12] - Внедрение Push-уведомлений

### Добавлено

#### Backend
- Установлена библиотека `web-push` для поддержки Web Push API
- Добавлены VAPID ключи для безопасной отправки push-уведомлений
- Реализован endpoint `GET /api/vapid-public-key` для получения публичного ключа клиентом
- Реализован endpoint `POST /api/stops/:stopId/subscribe` для регистрации подписок на уведомления
- Реализован endpoint `POST /api/stops/:stopId/unsubscribe` для отписки от уведомлений
- Добавлена логика автоматической отправки push-уведомлений при приближении транспорта к остановке
- Реализована защита от спама уведомлений (cooldown 5 минут)
- Автоматическая очистка невалидных подписок (статус 410/404)

#### Frontend
- Создан Service Worker (`/public/sw.js`) для обработки push-уведомлений
- Добавлен UI для управления push-уведомлениями на странице остановки
- Кнопка "Включить уведомления" / "Отключить уведомления" с визуальной индикацией статуса
- Автоматический запрос разрешения браузера на отправку уведомлений
- Интеграция с Push Manager API
- Регистрация подписки на сервере после получения разрешения
- Обработка клика по уведомлению (фокус на приложении)

#### Функциональность уведомлений
- Push-уведомления содержат:
  - Номер маршрута трамвая
  - Время до прибытия в минутах
  - Название остановки
- Уведомления отправляются автоматически когда транспорт находится в пределах заданного времени (по умолчанию 3 минуты)
- Уведомления работают даже когда вкладка браузера неактивна

#### Документация
- Создан файл `docs/tasks.yaml` с отметкой задачи #103 как выполненной
- Создан файл `docs/changelog.md` с описанием внедренных изменений
- Создан файл `docs/decisions.md` с архитектурным решением по push-уведомлениям

### Технические детали
- Использован стандарт Web Push API
- VAPID (Voluntary Application Server Identification) для аутентификации сервера
- Service Worker с поддержкой событий `push` и `notificationclick`
- Хранение подписок в памяти сервера (in-memory Map)
- Совместимость с современными браузерами: Chrome, Firefox, Edge

### Безопасность
- VAPID ключи можно настроить через переменные окружения
- Защита от спама через cooldown механизм
- Автоматическое удаление невалидных подписок
